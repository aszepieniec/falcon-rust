use std::ops::{Add, AddAssign, Mul, MulAssign, Neg, Sub, SubAssign};

use num::{One, Zero};

use crate::{cyclotomic_fourier::CyclotomicFourier, inverse::Inverse};

const N: usize = 512;

/// The vector of moduli by which we will be reducing every limb.
/// These were chosen as p where p-1 = 2^12 * cofactor, where
/// cofactor is some 18-bit integer that makes p prime. In fact,
/// this list corresponds to the N smallest such cofactors.
pub const MODULI: [u32; N] = [
    1073754113u32,
    1073950721u32,
    1073958913u32,
    1073983489u32,
    1074196481u32,
    1074343937u32,
    1074442241u32,
    1074475009u32,
    1074515969u32,
    1074524161u32,
    1074548737u32,
    1074589697u32,
    1074597889u32,
    1074688001u32,
    1074696193u32,
    1074810881u32,
    1074835457u32,
    1074941953u32,
    1075007489u32,
    1075064833u32,
    1075105793u32,
    1075351553u32,
    1075376129u32,
    1075449857u32,
    1075507201u32,
    1075621889u32,
    1075695617u32,
    1075720193u32,
    1075752961u32,
    1076039681u32,
    1076064257u32,
    1076162561u32,
    1076187137u32,
    1076211713u32,
    1076269057u32,
    1076334593u32,
    1076391937u32,
    1076531201u32,
    1076613121u32,
    1076908033u32,
    1076948993u32,
    1077047297u32,
    1077178369u32,
    1077252097u32,
    1077391361u32,
    1077399553u32,
    1077620737u32,
    1077686273u32,
    1077792769u32,
    1077882881u32,
    1078038529u32,
    1078079489u32,
    1078112257u32,
    1078153217u32,
    1078210561u32,
    1078333441u32,
    1078382593u32,
    1078398977u32,
    1078497281u32,
    1078505473u32,
    1078546433u32,
    1078571009u32,
    1078620161u32,
    1078775809u32,
    1078849537u32,
    1078939649u32,
    1079185409u32,
    1079193601u32,
    1079357441u32,
    1079431169u32,
    1079603201u32,
    1079627777u32,
    1079635969u32,
    1079676929u32,
    1079685121u32,
    1079734273u32,
    1079832577u32,
    1079848961u32,
    1079873537u32,
    1079922689u32,
    1080020993u32,
    1080348673u32,
    1080365057u32,
    1080446977u32,
    1080496129u32,
    1080512513u32,
    1080741889u32,
    1080864769u32,
    1080938497u32,
    1080954881u32,
    1081077761u32,
    1081225217u32,
    1081323521u32,
    1081348097u32,
    1081397249u32,
    1081430017u32,
    1081495553u32,
    1081577473u32,
    1081643009u32,
    1081700353u32,
    1081774081u32,
    1081815041u32,
    1081839617u32,
    1081921537u32,
    1082060801u32,
    1082093569u32,
    1082331137u32,
    1082462209u32,
    1082552321u32,
    1082601473u32,
    1082699777u32,
    1082724353u32,
    1082806273u32,
    1082904577u32,
    1082929153u32,
    1083002881u32,
    1083076609u32,
    1083117569u32,
    1083215873u32,
    1083289601u32,
    1083371521u32,
    1083518977u32,
    1083535361u32,
    1083928577u32,
    1083953153u32,
    1084076033u32,
    1084133377u32,
    1084149761u32,
    1084297217u32,
    1084477441u32,
    1084518401u32,
    1084641281u32,
    1084649473u32,
    1084674049u32,
    1084690433u32,
    1084813313u32,
    1084911617u32,
    1084968961u32,
    1085140993u32,
    1085181953u32,
    1085255681u32,
    1085411329u32,
    1085501441u32,
    1085534209u32,
    1085550593u32,
    1085607937u32,
    1085648897u32,
    1085673473u32,
    1085779969u32,
    1085796353u32,
    1085870081u32,
    1085894657u32,
    1085952001u32,
    1086066689u32,
    1086115841u32,
    1086345217u32,
    1086410753u32,
    1086443521u32,
    1086566401u32,
    1086713857u32,
    1086763009u32,
    1086853121u32,
    1086902273u32,
    1086935041u32,
    1087025153u32,
    1087148033u32,
    1087254529u32,
    1087303681u32,
    1087418369u32,
    1087451137u32,
    1087475713u32,
    1087492097u32,
    1087762433u32,
    1087836161u32,
    1087860737u32,
    1087885313u32,
    1088311297u32,
    1088376833u32,
    1088401409u32,
    1088409601u32,
    1088458753u32,
    1088606209u32,
    1088647169u32,
    1088679937u32,
    1088778241u32,
    1088802817u32,
    1088851969u32,
    1088868353u32,
    1088966657u32,
    1089220609u32,
    1089458177u32,
    1089540097u32,
    1089835009u32,
    1089949697u32,
    1090170881u32,
    1090179073u32,
    1090203649u32,
    1090293761u32,
    1090400257u32,
    1090490369u32,
    1090498561u32,
    1090646017u32,
    1090768897u32,
    1090867201u32,
    1091014657u32,
    1091104769u32,
    1091178497u32,
    1091399681u32,
    1091571713u32,
    1091850241u32,
    1092022273u32,
    1092038657u32,
    1092210689u32,
    1092268033u32,
    1092333569u32,
    1092636673u32,
    1092653057u32,
    1092661249u32,
    1092734977u32,
    1092882433u32,
    1092923393u32,
    1092997121u32,
    1093005313u32,
    1093152769u32,
    1093292033u32,
    1093414913u32,
    1093439489u32,
    1093513217u32,
    1093537793u32,
    1093570561u32,
    1093939201u32,
    1094184961u32,
    1094250497u32,
    1094258689u32,
    1094299649u32,
    1094356993u32,
    1094381569u32,
    1094430721u32,
    1094471681u32,
    1094504449u32,
    1094725633u32,
    1094889473u32,
    1094914049u32,
    1094946817u32,
    1094963201u32,
    1094995969u32,
    1095012353u32,
    1095045121u32,
    1095331841u32,
    1095462913u32,
    1095536641u32,
    1095585793u32,
    1095700481u32,
    1095708673u32,
    1095774209u32,
    1095847937u32,
    1096101889u32,
    1096142849u32,
    1096175617u32,
    1096216577u32,
    1096224769u32,
    1096339457u32,
    1096388609u32,
    1096396801u32,
    1096486913u32,
    1096544257u32,
    1096609793u32,
    1096716289u32,
    1096765441u32,
    1096880129u32,
    1096937473u32,
    1096953857u32,
    1096962049u32,
    1097076737u32,
    1097175041u32,
    1097183233u32,
    1097199617u32,
    1097256961u32,
    1097306113u32,
    1097322497u32,
    1097453569u32,
    1097469953u32,
    1097527297u32,
    1097691137u32,
    1097715713u32,
    1097748481u32,
    1097895937u32,
    1098035201u32,
    1098084353u32,
    1098231809u32,
    1098280961u32,
    1098313729u32,
    1098387457u32,
    1098403841u32,
    1098485761u32,
    1098731521u32,
    1098756097u32,
    1098780673u32,
    1098805249u32,
    1098854401u32,
    1098919937u32,
    1099042817u32,
    1099067393u32,
    1099272193u32,
    1099296769u32,
    1099370497u32,
    1099411457u32,
    1099591681u32,
    1099665409u32,
    1099755521u32,
    1099763713u32,
    1100001281u32,
    1100132353u32,
    1100173313u32,
    1100296193u32,
    1100451841u32,
    1100492801u32,
    1100500993u32,
    1100574721u32,
    1100623873u32,
    1100689409u32,
    1100697601u32,
    1100812289u32,
    1100820481u32,
    1100861441u32,
    1100894209u32,
    1101107201u32,
    1101139969u32,
    1101189121u32,
    1101213697u32,
    1101352961u32,
    1101361153u32,
    1101385729u32,
    1101434881u32,
    1101549569u32,
    1101557761u32,
    1101598721u32,
    1101623297u32,
    1101672449u32,
    1101729793u32,
    1101852673u32,
    1101926401u32,
    1102041089u32,
    1102163969u32,
    1102295041u32,
    1102360577u32,
    1102483457u32,
    1102532609u32,
    1102565377u32,
    1102712833u32,
    1102860289u32,
    1102934017u32,
    1103147009u32,
    1103196161u32,
    1103245313u32,
    1103343617u32,
    1103548417u32,
    1103835137u32,
    1103843329u32,
    1103917057u32,
    1103966209u32,
    1104007169u32,
    1104261121u32,
    1104408577u32,
    1104457729u32,
    1104654337u32,
    1104695297u32,
    1104703489u32,
    1104719873u32,
    1104867329u32,
    1105195009u32,
    1105309697u32,
    1105367041u32,
    1105408001u32,
    1105457153u32,
    1105489921u32,
    1105514497u32,
    1105555457u32,
    1105580033u32,
    1105604609u32,
    1105686529u32,
    1105784833u32,
    1105825793u32,
    1105883137u32,
    1105907713u32,
    1105981441u32,
    1106030593u32,
    1106071553u32,
    1106227201u32,
    1106300929u32,
    1106350081u32,
    1106374657u32,
    1106399233u32,
    1106464769u32,
    1106513921u32,
    1106538497u32,
    1106546689u32,
    1106710529u32,
    1106931713u32,
    1107030017u32,
    1107054593u32,
    1107521537u32,
    1107619841u32,
    1107668993u32,
    1107816449u32,
    1108013057u32,
    1108021249u32,
    1108062209u32,
    1108135937u32,
    1108144129u32,
    1108217857u32,
    1108381697u32,
    1108430849u32,
    1108439041u32,
    1108463617u32,
    1108488193u32,
    1108553729u32,
    1108586497u32,
    1108611073u32,
    1108750337u32,
    1108774913u32,
    1108922369u32,
    1108979713u32,
    1109004289u32,
    1109094401u32,
    1109127169u32,
    1109217281u32,
    1109299201u32,
    1109323777u32,
    1109618689u32,
    1109692417u32,
    1109708801u32,
    1109880833u32,
    1109962753u32,
    1110085633u32,
    1110151169u32,
    1110224897u32,
    1110249473u32,
    1110282241u32,
    1110306817u32,
    1110454273u32,
    1110716417u32,
    1111109633u32,
    1111166977u32,
    1111183361u32,
    1111216129u32,
    1111232513u32,
    1111257089u32,
    1111412737u32,
    1111461889u32,
    1111502849u32,
    1111560193u32,
    1111584769u32,
    1111625729u32,
    1111658497u32,
    1111683073u32,
    1111756801u32,
    1111797761u32,
    1111822337u32,
    1111928833u32,
    1111994369u32,
    1112043521u32,
    1112174593u32,
    1112289281u32,
    1112338433u32,
    1112363009u32,
    1112371201u32,
    1112494081u32,
    1112567809u32,
    1112682497u32,
    1112739841u32,
    1112887297u32,
    1112952833u32,
    1112977409u32,
    1113059329u32,
    1113346049u32,
    1113403393u32,
    1113567233u32,
    1113600001u32,
    1113747457u32,
    1113886721u32,
    1113894913u32,
    1113935873u32,
    1114034177u32,
    1114165249u32,
    1114238977u32,
    1114451969u32,
    1114632193u32,
    1114746881u32,
    1114771457u32,
    1114894337u32,
    1115025409u32,
    1115074561u32,
    1115148289u32,
    1115410433u32,
    1115492353u32,
    1115590657u32,
    1115615233u32,
    1115631617u32,
    1115713537u32,
    1115729921u32,
    1115762689u32,
    1115803649u32,
    1115901953u32,
    1116131329u32,
    1116270593u32,
    1116418049u32,
    1116549121u32,
    1116639233u32,
    1116794881u32,
    1116917761u32,
    1116991489u32,
];

#[derive(Debug, Clone, Copy)]
pub(crate) struct PrimeField<const P: u32>(pub(crate) u32);

impl<const P: u32> Add for PrimeField<P> {
    type Output = PrimeField<P>;

    fn add(self, rhs: Self) -> Self::Output {
        PrimeField::<P>((((self.0 as u64) + (rhs.0 as u64)) % (P as u64)) as u32)
    }
}

impl<const P: u32> Mul for PrimeField<P> {
    type Output = PrimeField<P>;

    fn mul(self, rhs: Self) -> Self::Output {
        PrimeField::<P>((((self.0 as u64) * (rhs.0 as u64)) % (P as u64)) as u32)
    }
}

impl<const P: u32> Sub for PrimeField<P> {
    type Output = PrimeField<P>;

    fn sub(self, rhs: Self) -> Self::Output {
        PrimeField::<P>((((self.0 as u64) + (P as u64) - (rhs.0 as u64)) % (P as u64)) as u32)
    }
}

impl<const P: u32> AddAssign for PrimeField<P> {
    fn add_assign(&mut self, rhs: Self) {
        self.0 = (((self.0 as u64) + (rhs.0 as u64)) % (P as u64)) as u32;
    }
}

impl<const P: u32> SubAssign for PrimeField<P> {
    fn sub_assign(&mut self, rhs: Self) {
        self.0 = (((self.0 as u64) + ((P as u64) - (rhs.0 as u64))) % (P as u64)) as u32;
    }
}

impl<const P: u32> MulAssign for PrimeField<P> {
    fn mul_assign(&mut self, rhs: Self) {
        self.0 = (((self.0 as u64) * (rhs.0 as u64)) % (P as u64)) as u32;
    }
}

impl<const P: u32> One for PrimeField<P> {
    fn one() -> Self {
        Self(1u32)
    }
}

impl<const P: u32> Zero for PrimeField<P> {
    fn zero() -> Self {
        Self(0u32)
    }

    fn is_zero(&self) -> bool {
        self.0 == 0u32
    }
}

impl<const P: u32> Inverse for PrimeField<P> {
    fn inverse_or_zero(self) -> Self {
        let mut acc = Self::one();
        for i in (0..32).rev() {
            acc *= acc;
            if (1 << i) & (P - 2) != 0 {
                acc *= self;
            }
        }
        acc
    }
}

impl<const P: u32> CyclotomicFourier for PrimeField<P> {
    fn primitive_root_of_unity(n: usize) -> Self {
        let mut root = Self(root_of_unity_4096(P));
        for _ in n.ilog2()..12 {
            root = root * root;
        }
        root
    }
}

fn root_of_unity_4096(p: u32) -> u32 {
    match p {
        1073754113u32 => 48440u32,
        1073950721u32 => 32033u32,
        1073958913u32 => 105315u32,
        1073983489u32 => 661217u32,
        1074196481u32 => 2872u32,
        1074343937u32 => 312461u32,
        1074442241u32 => 135843u32,
        1074475009u32 => 433069u32,
        1074515969u32 => 407521u32,
        1074524161u32 => 988646u32,
        1074548737u32 => 211582u32,
        1074589697u32 => 292708u32,
        1074597889u32 => 660222u32,
        1074688001u32 => 416412u32,
        1074696193u32 => 361109u32,
        1074810881u32 => 1501888u32,
        1074835457u32 => 1002812u32,
        1074941953u32 => 70152u32,
        1075007489u32 => 72221u32,
        1075064833u32 => 91935u32,
        1075105793u32 => 96986u32,
        1075351553u32 => 491583u32,
        1075376129u32 => 23197u32,
        1075449857u32 => 442926u32,
        1075507201u32 => 65212u32,
        1075621889u32 => 28560u32,
        1075695617u32 => 1384994u32,
        1075720193u32 => 2355626u32,
        1075752961u32 => 171856u32,
        1076039681u32 => 582542u32,
        1076064257u32 => 60608u32,
        1076162561u32 => 79179u32,
        1076187137u32 => 11582u32,
        1076211713u32 => 475437u32,
        1076269057u32 => 1506429u32,
        1076334593u32 => 170255u32,
        1076391937u32 => 116594u32,
        1076531201u32 => 457251u32,
        1076613121u32 => 23490u32,
        1076908033u32 => 888888u32,
        1076948993u32 => 175992u32,
        1077047297u32 => 100385u32,
        1077178369u32 => 361242u32,
        1077252097u32 => 878194u32,
        1077391361u32 => 65577u32,
        1077399553u32 => 828959u32,
        1077620737u32 => 139933u32,
        1077686273u32 => 139655u32,
        1077792769u32 => 622031u32,
        1077882881u32 => 794707u32,
        1078038529u32 => 613293u32,
        1078079489u32 => 155863u32,
        1078112257u32 => 75172u32,
        1078153217u32 => 461903u32,
        1078210561u32 => 932090u32,
        1078333441u32 => 1439401u32,
        1078382593u32 => 197705u32,
        1078398977u32 => 68737u32,
        1078497281u32 => 651960u32,
        1078505473u32 => 703312u32,
        1078546433u32 => 284662u32,
        1078571009u32 => 250295u32,
        1078620161u32 => 2982783u32,
        1078775809u32 => 899145u32,
        1078849537u32 => 84761u32,
        1078939649u32 => 22517u32,
        1079185409u32 => 360819u32,
        1079193601u32 => 119679u32,
        1079357441u32 => 55440u32,
        1079431169u32 => 624161u32,
        1079603201u32 => 563187u32,
        1079627777u32 => 1256363u32,
        1079635969u32 => 7546u32,
        1079676929u32 => 587544u32,
        1079685121u32 => 43544u32,
        1079734273u32 => 774321u32,
        1079832577u32 => 720864u32,
        1079848961u32 => 425219u32,
        1079873537u32 => 1471550u32,
        1079922689u32 => 65948u32,
        1080020993u32 => 667559u32,
        1080348673u32 => 507532u32,
        1080365057u32 => 251673u32,
        1080446977u32 => 608032u32,
        1080496129u32 => 218661u32,
        1080512513u32 => 543601u32,
        1080741889u32 => 99383u32,
        1080864769u32 => 297866u32,
        1080938497u32 => 423622u32,
        1080954881u32 => 1590842u32,
        1081077761u32 => 130880u32,
        1081225217u32 => 433113u32,
        1081323521u32 => 64610u32,
        1081348097u32 => 411475u32,
        1081397249u32 => 882483u32,
        1081430017u32 => 110379u32,
        1081495553u32 => 1261186u32,
        1081577473u32 => 1587852u32,
        1081643009u32 => 1187753u32,
        1081700353u32 => 1423968u32,
        1081774081u32 => 94011u32,
        1081815041u32 => 184865u32,
        1081839617u32 => 161130u32,
        1081921537u32 => 202318u32,
        1082060801u32 => 33230u32,
        1082093569u32 => 365317u32,
        1082331137u32 => 432020u32,
        1082462209u32 => 396831u32,
        1082552321u32 => 291384u32,
        1082601473u32 => 1434334u32,
        1082699777u32 => 372839u32,
        1082724353u32 => 550796u32,
        1082806273u32 => 1136235u32,
        1082904577u32 => 1094060u32,
        1082929153u32 => 169112u32,
        1083002881u32 => 523372u32,
        1083076609u32 => 567555u32,
        1083117569u32 => 157143u32,
        1083215873u32 => 550395u32,
        1083289601u32 => 715848u32,
        1083371521u32 => 122597u32,
        1083518977u32 => 1917704u32,
        1083535361u32 => 210077u32,
        1083928577u32 => 214585u32,
        1083953153u32 => 272789u32,
        1084076033u32 => 928745u32,
        1084133377u32 => 1145577u32,
        1084149761u32 => 157065u32,
        1084297217u32 => 261225u32,
        1084477441u32 => 798309u32,
        1084518401u32 => 1109373u32,
        1084641281u32 => 282397u32,
        1084649473u32 => 2195937u32,
        1084674049u32 => 57476u32,
        1084690433u32 => 1162223u32,
        1084813313u32 => 1463065u32,
        1084911617u32 => 955149u32,
        1084968961u32 => 423861u32,
        1085140993u32 => 209024u32,
        1085181953u32 => 1251435u32,
        1085255681u32 => 3229560u32,
        1085411329u32 => 29553u32,
        1085501441u32 => 1192651u32,
        1085534209u32 => 601864u32,
        1085550593u32 => 15692u32,
        1085607937u32 => 78870u32,
        1085648897u32 => 570856u32,
        1085673473u32 => 1745024u32,
        1085779969u32 => 95199u32,
        1085796353u32 => 243260u32,
        1085870081u32 => 1380116u32,
        1085894657u32 => 717175u32,
        1085952001u32 => 501293u32,
        1086066689u32 => 327442u32,
        1086115841u32 => 148163u32,
        1086345217u32 => 20315u32,
        1086410753u32 => 308768u32,
        1086443521u32 => 951292u32,
        1086566401u32 => 668235u32,
        1086713857u32 => 308667u32,
        1086763009u32 => 1770764u32,
        1086853121u32 => 910129u32,
        1086902273u32 => 1269422u32,
        1086935041u32 => 200643u32,
        1087025153u32 => 472048u32,
        1087148033u32 => 1169282u32,
        1087254529u32 => 1472309u32,
        1087303681u32 => 1737639u32,
        1087418369u32 => 453419u32,
        1087451137u32 => 181615u32,
        1087475713u32 => 207058u32,
        1087492097u32 => 31765u32,
        1087762433u32 => 67206u32,
        1087836161u32 => 699743u32,
        1087860737u32 => 668582u32,
        1087885313u32 => 368647u32,
        1088311297u32 => 327190u32,
        1088376833u32 => 194045u32,
        1088401409u32 => 121812u32,
        1088409601u32 => 6713u32,
        1088458753u32 => 1905892u32,
        1088606209u32 => 203u32,
        1088647169u32 => 529868u32,
        1088679937u32 => 1882420u32,
        1088778241u32 => 480252u32,
        1088802817u32 => 406893u32,
        1088851969u32 => 646348u32,
        1088868353u32 => 537738u32,
        1088966657u32 => 76592u32,
        1089220609u32 => 426417u32,
        1089458177u32 => 258908u32,
        1089540097u32 => 183616u32,
        1089835009u32 => 1037166u32,
        1089949697u32 => 785216u32,
        1090170881u32 => 737986u32,
        1090179073u32 => 1601904u32,
        1090203649u32 => 940119u32,
        1090293761u32 => 183634u32,
        1090400257u32 => 652515u32,
        1090490369u32 => 1171802u32,
        1090498561u32 => 621812u32,
        1090646017u32 => 252683u32,
        1090768897u32 => 461198u32,
        1090867201u32 => 1111450u32,
        1091014657u32 => 70051u32,
        1091104769u32 => 578202u32,
        1091178497u32 => 222666u32,
        1091399681u32 => 532774u32,
        1091571713u32 => 615078u32,
        1091850241u32 => 336481u32,
        1092022273u32 => 341326u32,
        1092038657u32 => 184273u32,
        1092210689u32 => 94284u32,
        1092268033u32 => 288226u32,
        1092333569u32 => 32650u32,
        1092636673u32 => 193918u32,
        1092653057u32 => 285361u32,
        1092661249u32 => 157630u32,
        1092734977u32 => 1255483u32,
        1092882433u32 => 331961u32,
        1092923393u32 => 161485u32,
        1092997121u32 => 366401u32,
        1093005313u32 => 195943u32,
        1093152769u32 => 416123u32,
        1093292033u32 => 27677u32,
        1093414913u32 => 4288672u32,
        1093439489u32 => 531933u32,
        1093513217u32 => 2083229u32,
        1093537793u32 => 641327u32,
        1093570561u32 => 847817u32,
        1093939201u32 => 273033u32,
        1094184961u32 => 479761u32,
        1094250497u32 => 200174u32,
        1094258689u32 => 423493u32,
        1094299649u32 => 178872u32,
        1094356993u32 => 357711u32,
        1094381569u32 => 1630200u32,
        1094430721u32 => 141878u32,
        1094471681u32 => 882065u32,
        1094504449u32 => 344233u32,
        1094725633u32 => 401775u32,
        1094889473u32 => 764843u32,
        1094914049u32 => 58256u32,
        1094946817u32 => 587187u32,
        1094963201u32 => 136207u32,
        1094995969u32 => 248448u32,
        1095012353u32 => 102402u32,
        1095045121u32 => 200987u32,
        1095331841u32 => 68193u32,
        1095462913u32 => 2040467u32,
        1095536641u32 => 290154u32,
        1095585793u32 => 390837u32,
        1095700481u32 => 790689u32,
        1095708673u32 => 222115u32,
        1095774209u32 => 1155165u32,
        1095847937u32 => 41642u32,
        1096101889u32 => 142172u32,
        1096142849u32 => 449999u32,
        1096175617u32 => 505600u32,
        1096216577u32 => 471942u32,
        1096224769u32 => 582635u32,
        1096339457u32 => 1853282u32,
        1096388609u32 => 722966u32,
        1096396801u32 => 432655u32,
        1096486913u32 => 556090u32,
        1096544257u32 => 169596u32,
        1096609793u32 => 1047385u32,
        1096716289u32 => 74554u32,
        1096765441u32 => 195662u32,
        1096880129u32 => 431375u32,
        1096937473u32 => 492649u32,
        1096953857u32 => 915628u32,
        1096962049u32 => 1351301u32,
        1097076737u32 => 156621u32,
        1097175041u32 => 254886u32,
        1097183233u32 => 1155302u32,
        1097199617u32 => 281432u32,
        1097256961u32 => 325587u32,
        1097306113u32 => 362611u32,
        1097322497u32 => 301402u32,
        1097453569u32 => 255417u32,
        1097469953u32 => 93403u32,
        1097527297u32 => 153882u32,
        1097691137u32 => 73050u32,
        1097715713u32 => 595907u32,
        1097748481u32 => 132928u32,
        1097895937u32 => 537145u32,
        1098035201u32 => 46695u32,
        1098084353u32 => 610267u32,
        1098231809u32 => 507436u32,
        1098280961u32 => 1746911u32,
        1098313729u32 => 337552u32,
        1098387457u32 => 461008u32,
        1098403841u32 => 1086191u32,
        1098485761u32 => 225278u32,
        1098731521u32 => 530762u32,
        1098756097u32 => 299596u32,
        1098780673u32 => 20725u32,
        1098805249u32 => 448996u32,
        1098854401u32 => 646034u32,
        1098919937u32 => 391747u32,
        1099042817u32 => 111404u32,
        1099067393u32 => 98150u32,
        1099272193u32 => 416107u32,
        1099296769u32 => 92904u32,
        1099370497u32 => 3472254u32,
        1099411457u32 => 818191u32,
        1099591681u32 => 345675u32,
        1099665409u32 => 33u32,
        1099755521u32 => 268338u32,
        1099763713u32 => 1805u32,
        1100001281u32 => 94581u32,
        1100132353u32 => 1290372u32,
        1100173313u32 => 333023u32,
        1100296193u32 => 153236u32,
        1100451841u32 => 76757u32,
        1100492801u32 => 445592u32,
        1100500993u32 => 225357u32,
        1100574721u32 => 37002u32,
        1100623873u32 => 666268u32,
        1100689409u32 => 1135312u32,
        1100697601u32 => 112749u32,
        1100812289u32 => 415011u32,
        1100820481u32 => 543808u32,
        1100861441u32 => 1128678u32,
        1100894209u32 => 825338u32,
        1101107201u32 => 733694u32,
        1101139969u32 => 424569u32,
        1101189121u32 => 47273u32,
        1101213697u32 => 1016392u32,
        1101352961u32 => 309493u32,
        1101361153u32 => 947246u32,
        1101385729u32 => 38614u32,
        1101434881u32 => 136004u32,
        1101549569u32 => 2653628u32,
        1101557761u32 => 1177114u32,
        1101598721u32 => 314884u32,
        1101623297u32 => 45923u32,
        1101672449u32 => 643183u32,
        1101729793u32 => 809336u32,
        1101852673u32 => 69172u32,
        1101926401u32 => 668032u32,
        1102041089u32 => 189480u32,
        1102163969u32 => 310669u32,
        1102295041u32 => 528599u32,
        1102360577u32 => 290563u32,
        1102483457u32 => 652348u32,
        1102532609u32 => 40118u32,
        1102565377u32 => 270152u32,
        1102712833u32 => 107086u32,
        1102860289u32 => 255194u32,
        1102934017u32 => 836951u32,
        1103147009u32 => 129893u32,
        1103196161u32 => 614338u32,
        1103245313u32 => 101343u32,
        1103343617u32 => 223151u32,
        1103548417u32 => 158015u32,
        1103835137u32 => 815159u32,
        1103843329u32 => 367117u32,
        1103917057u32 => 376614u32,
        1103966209u32 => 1136651u32,
        1104007169u32 => 963351u32,
        1104261121u32 => 262452u32,
        1104408577u32 => 359731u32,
        1104457729u32 => 162881u32,
        1104654337u32 => 73618u32,
        1104695297u32 => 741467u32,
        1104703489u32 => 633459u32,
        1104719873u32 => 50337u32,
        1104867329u32 => 222671u32,
        1105195009u32 => 73074u32,
        1105309697u32 => 21330u32,
        1105367041u32 => 72795u32,
        1105408001u32 => 37382u32,
        1105457153u32 => 154285u32,
        1105489921u32 => 152634u32,
        1105514497u32 => 2322063u32,
        1105555457u32 => 189954u32,
        1105580033u32 => 1038715u32,
        1105604609u32 => 665371u32,
        1105686529u32 => 813748u32,
        1105784833u32 => 176627u32,
        1105825793u32 => 282061u32,
        1105883137u32 => 279707u32,
        1105907713u32 => 437100u32,
        1105981441u32 => 33665u32,
        1106030593u32 => 573284u32,
        1106071553u32 => 87231u32,
        1106227201u32 => 688621u32,
        1106300929u32 => 437450u32,
        1106350081u32 => 73065u32,
        1106374657u32 => 799346u32,
        1106399233u32 => 82293u32,
        1106464769u32 => 445923u32,
        1106513921u32 => 1530u32,
        1106538497u32 => 12166u32,
        1106546689u32 => 473383u32,
        1106710529u32 => 112922u32,
        1106931713u32 => 156875u32,
        1107030017u32 => 37145u32,
        1107054593u32 => 1963483u32,
        1107521537u32 => 95438u32,
        1107619841u32 => 896311u32,
        1107668993u32 => 332237u32,
        1107816449u32 => 158636u32,
        1108013057u32 => 693973u32,
        1108021249u32 => 1075931u32,
        1108062209u32 => 327178u32,
        1108135937u32 => 844631u32,
        1108144129u32 => 218304u32,
        1108217857u32 => 592477u32,
        1108381697u32 => 66589u32,
        1108430849u32 => 85392u32,
        1108439041u32 => 5971u32,
        1108463617u32 => 197613u32,
        1108488193u32 => 26650u32,
        1108553729u32 => 1096406u32,
        1108586497u32 => 313332u32,
        1108611073u32 => 216332u32,
        1108750337u32 => 539851u32,
        1108774913u32 => 1300220u32,
        1108922369u32 => 76278u32,
        1108979713u32 => 85299u32,
        1109004289u32 => 2540847u32,
        1109094401u32 => 1626228u32,
        1109127169u32 => 310544u32,
        1109217281u32 => 1167592u32,
        1109299201u32 => 164117u32,
        1109323777u32 => 1415165u32,
        1109618689u32 => 36038u32,
        1109692417u32 => 307845u32,
        1109708801u32 => 361394u32,
        1109880833u32 => 2428759u32,
        1109962753u32 => 1038372u32,
        1110085633u32 => 198062u32,
        1110151169u32 => 479710u32,
        1110224897u32 => 309058u32,
        1110249473u32 => 413300u32,
        1110282241u32 => 658764u32,
        1110306817u32 => 706845u32,
        1110454273u32 => 679209u32,
        1110716417u32 => 514121u32,
        1111109633u32 => 1304575u32,
        1111166977u32 => 927733u32,
        1111183361u32 => 618347u32,
        1111216129u32 => 805101u32,
        1111232513u32 => 918401u32,
        1111257089u32 => 508099u32,
        1111412737u32 => 194754u32,
        1111461889u32 => 428964u32,
        1111502849u32 => 1282672u32,
        1111560193u32 => 26161u32,
        1111584769u32 => 248012u32,
        1111625729u32 => 70070u32,
        1111658497u32 => 277583u32,
        1111683073u32 => 261933u32,
        1111756801u32 => 396371u32,
        1111797761u32 => 1039613u32,
        1111822337u32 => 981652u32,
        1111928833u32 => 920863u32,
        1111994369u32 => 1256515u32,
        1112043521u32 => 685883u32,
        1112174593u32 => 191497u32,
        1112289281u32 => 1387848u32,
        1112338433u32 => 173634u32,
        1112363009u32 => 55556u32,
        1112371201u32 => 364633u32,
        1112494081u32 => 736125u32,
        1112567809u32 => 629534u32,
        1112682497u32 => 658427u32,
        1112739841u32 => 3645846u32,
        1112887297u32 => 561352u32,
        1112952833u32 => 30723u32,
        1112977409u32 => 86423u32,
        1113059329u32 => 279245u32,
        1113346049u32 => 12378u32,
        1113403393u32 => 654172u32,
        1113567233u32 => 1353365u32,
        1113600001u32 => 582870u32,
        1113747457u32 => 410900u32,
        1113886721u32 => 404209u32,
        1113894913u32 => 451817u32,
        1113935873u32 => 281179u32,
        1114034177u32 => 80885u32,
        1114165249u32 => 83446u32,
        1114238977u32 => 126077u32,
        1114451969u32 => 1011248u32,
        1114632193u32 => 6536u32,
        1114746881u32 => 40979u32,
        1114771457u32 => 75118u32,
        1114894337u32 => 273185u32,
        1115025409u32 => 891615u32,
        1115074561u32 => 975014u32,
        1115148289u32 => 683562u32,
        1115410433u32 => 401772u32,
        1115492353u32 => 484440u32,
        1115590657u32 => 413755u32,
        1115615233u32 => 663447u32,
        1115631617u32 => 552041u32,
        1115713537u32 => 18764u32,
        1115729921u32 => 183180u32,
        1115762689u32 => 27878u32,
        1115803649u32 => 1094433u32,
        1115901953u32 => 297757u32,
        1116131329u32 => 774640u32,
        1116270593u32 => 537048u32,
        1116418049u32 => 841858u32,
        1116549121u32 => 905085u32,
        1116639233u32 => 98888u32,
        1116794881u32 => 1214904u32,
        1116917761u32 => 71501u32,
        1116991489u32 => 271036u32,

        _ => unimplemented!(),
    }
}

impl<const P: u32> PartialEq for PrimeField<P> {
    fn eq(&self, other: &Self) -> bool {
        self.0 == other.0
    }
}

impl<const P: u32> Neg for PrimeField<P> {
    type Output = PrimeField<P>;

    fn neg(self) -> Self::Output {
        PrimeField::<P>((P - self.0) % P)
    }
}

impl<const P: u32> From<u32> for PrimeField<P> {
    fn from(value: u32) -> Self {
        PrimeField::<P>(value % P)
    }
}

#[cfg(test)]
mod test {
    use crate::residue_number_system::root_of_unity_4096;

    use super::MODULI;

    #[test]
    fn roots_have_right_order() {
        for p in MODULI {
            let mut r = root_of_unity_4096(p);
            for _ in 0..12 {
                assert_ne!(r, 1);
                r = (((r as u64) * (r as u64)) % (p as u64)) as u32;
            }
            assert_eq!(r, 1);
        }
    }
}
